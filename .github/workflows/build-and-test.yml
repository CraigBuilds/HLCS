name: Build and Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build ROS2 Package
    runs-on: ubuntu-latest
    container:
      image: ros:humble
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Cache pip packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        apt-get update && apt-get install -y \
          python3-pip \
          libgl1 \
          libglib2.0-0 \
          libdbus-1-3 \
          libegl1 \
          libfontconfig1 \
          libxkbcommon0
        pip3 install -r requirements.txt
    
    - name: Build package
      shell: bash
      run: |
        source /opt/ros/humble/setup.bash && \
        colcon build --packages-select hlcs

  test:
    name: Test ${{ matrix.test-name }}
    needs: build
    runs-on: ubuntu-latest
    container:
      image: ros:humble
    strategy:
      fail-fast: false
      matrix:
        include:
          - test-name: OPC UA Simulator
            test-file: test_sim.py
          - test-name: Driver Node
            test-file: test_driver.py
          - test-name: GUI Node
            test-file: test_gui.py
          - test-name: Smoke Tests
            test-file: test_smoke.py
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Cache pip packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        apt-get update && apt-get install -y \
          python3-pip \
          libgl1 \
          libglib2.0-0 \
          libdbus-1-3 \
          libegl1 \
          libfontconfig1 \
          libxkbcommon0
        pip3 install -r requirements.txt
    
    - name: Build package
      shell: bash
      run: |
        source /opt/ros/humble/setup.bash && \
        colcon build --packages-select hlcs
    
    - name: Run tests
      shell: bash
      run: |
        source /opt/ros/humble/setup.bash && \
        source install/setup.bash && \
        python3 -m pytest test/${{ matrix.test-file }} -v
